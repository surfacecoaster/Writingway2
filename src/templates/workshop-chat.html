<!-- Workshop Chat Component -->
<!-- Can be used in modal mode or embedded mode -->
<!-- Pass mode parameter: 'modal' or 'embedded' -->
<div class="workshop-chat-container" :class="workshopMode === 'embedded' ? 'workshop-embedded' : ''">
    <!-- Left: Sessions List -->
    <div class="workshop-sessions">
        <div class="workshop-sessions-header">
            <h4 style="margin:0;font-size:14px;">Conversations</h4>
            <button class="btn btn-secondary btn-sm" @click="createWorkshopSession" title="New Chat">+</button>
        </div>
        <div class="workshop-sessions-list">
            <template x-for="(session, idx) in workshopSessions" :key="session.id">
                <div class="workshop-session-item" :class="{ 'active': idx === currentWorkshopSessionIndex }"
                    @click="currentWorkshopSessionIndex = idx" x-data="{ menuOpen: false }">
                    <span x-text="session.name"
                        style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
                    <div style="position:relative;">
                        <button class="btn-icon-sm" @click.stop="menuOpen = !menuOpen" title="Options">‚ãØ</button>
                        <div x-show="menuOpen" @click.away="menuOpen = false" x-cloak class="action-menu"
                            style="right:0;top:100%;margin-top:4px;">
                            <button @click.stop="renameWorkshopSession(idx); menuOpen=false">Rename</button>
                            <button @click.stop="clearWorkshopSession(idx); menuOpen=false">Clear Messages</button>
                            <button @click.stop="exportWorkshopSession(idx); menuOpen=false">Export as Markdown</button>
                            <button @click.stop="deleteWorkshopSession(idx); menuOpen=false"
                                style="color:var(--danger,#ef4444);">Delete</button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Center: Chat Area -->
    <div class="workshop-chat-main">
        <!-- Header -->
        <div class="workshop-chat-header">
            <div style="display:flex;align-items:center;gap:12px;flex:1;flex-wrap:wrap;">
                <h3 style="margin:0;font-size:18px;" x-show="workshopMode !== 'embedded'">Workshop Chat</h3>
                <select x-model="aiModel" @change="saveGenerationParams()" class="workshop-select"
                    title="AI Model for this chat" x-show="aiMode === 'api' || availableLocalModels.length > 0">
                    <template x-for="model in (aiMode === 'api' ? (providerModels[aiProvider] || []) : [])"
                        :key="model.id">
                        <option :value="model.id" x-text="model.name + (model.recommended ? ' ‚≠ê' : '')">
                        </option>
                    </template>
                    <template x-for="modelName in (aiMode === 'local' ? availableLocalModels : [])" :key="modelName">
                        <option :value="modelName" x-text="modelName"></option>
                    </template>
                    <!-- Show current model if not in lists -->
                    <option
                        x-show="aiModel && ((aiMode === 'api' && !(providerModels[aiProvider] || []).find(m => m.id === aiModel)) || (aiMode === 'local' && !availableLocalModels.includes(aiModel)))"
                        :value="aiModel" x-text="aiModel"></option>
                </select>
                <span x-show="aiMode === 'local' && availableLocalModels.length === 0"
                    style="padding:4px 12px;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:6px;font-size:12px;">
                    ‚úì Local Model Active
                </span>
                <select x-model="selectedWorkshopPromptId" @change="saveSelectedWorkshopPrompt" class="workshop-select">
                    <option value="">Default Workshop Prompt</option>
                    <template x-for="p in prompts.filter(p => p.category === 'workshop')" :key="p.id">
                        <option :value="p.id" x-text="p.title"></option>
                    </template>
                </select>
                <select x-model="workshopFidelityMode" class="workshop-select">
                    <option value="high">High Fidelity</option>
                    <option value="balanced">Balanced</option>
                    <option value="compressed">Compressed</option>
                </select>
                <button class="btn btn-secondary" @click="useWorkshopContextPanel = !useWorkshopContextPanel"
                    :style="useWorkshopContextPanel ? 'background: rgba(76,175,80,0.2); border-color: rgba(76,175,80,0.5);' : ''"
                    title="Use context from Context Panel">
                    üìö
                </button>
            </div>
            <button class="btn btn-secondary" @click="showWorkshopChat = false"
                x-show="workshopMode !== 'embedded'">Close</button>
            <button class="btn btn-secondary" @click="showEmbeddedWorkshop = false"
                x-show="workshopMode === 'embedded'">Close</button>
        </div>

        <!-- Messages -->
        <div class="workshop-messages" id="workshopMessages">
            <template
                x-if="workshopSessions[currentWorkshopSessionIndex] && workshopSessions[currentWorkshopSessionIndex].messages.length === 0">
                <div class="workshop-empty-state">
                    <p style="color:var(--text-secondary);margin:0;">Start a conversation with the AI!</p>
                    <p style="color:var(--text-secondary);font-size:13px;margin:8px 0 0 0;">
                        Use <code>@name</code> to reference compendium entries or <code>#scene</code>
                        to reference scenes.
                    </p>
                </div>
            </template>
            <template x-if="workshopSessions[currentWorkshopSessionIndex]">
                <template x-for="(msg, idx) in workshopSessions[currentWorkshopSessionIndex].messages" :key="idx">
                    <div class="workshop-message"
                        :class="`workshop-message-${msg.role}` + (msg.isError ? ' workshop-message-error' : '')">
                        <div class="workshop-message-header">
                            <div class="workshop-message-icon">
                                <span x-show="msg.role === 'user'">üë§</span>
                                <span x-show="msg.role === 'assistant' && !msg.isError">ü§ñ</span>
                                <span x-show="msg.isError">‚ö†Ô∏è</span>
                            </div>
                            <div class="workshop-message-role"
                                x-text="msg.role === 'user' ? 'You' : (msg.isError ? 'Error' : 'Assistant')">
                            </div>
                        </div>
                        <div class="workshop-message-content">
                            <template x-if="msg.content">
                                <span x-text="msg.content"></span>
                            </template>
                            <template x-if="!msg.content && msg.role === 'assistant' && workshopIsGenerating">
                                <span class="typing-indicator">‚óè‚óè‚óè</span>
                            </template>
                        </div>
                    </div>
                </template>
            </template>
        </div>

        <!-- Input Area -->
        <div class="workshop-input-area">
            <div class="workshop-input-wrapper" style="position:relative;">
                <textarea x-model="workshopInput" @input="window.workshopChat.onWorkshopInput($data, $event)"
                    @keydown="window.workshopChat.handleWorkshopKeydown($data, $event)" @keydown.enter.prevent="
                                        if (!$event.shiftKey && workshopInput.trim() && !showWorkshopQuickSearch && !showWorkshopSceneSearch) {
                                            window.workshopChat.sendMessage($data, workshopInput);
                                        }
                                    " placeholder="Type your message... (Use @name for compendium, #scene for scenes)"
                    rows="3" class="workshop-textarea" :disabled="workshopIsGenerating"></textarea>

                <!-- Compendium Quick Search Dropdown -->
                <div x-show="showWorkshopQuickSearch" x-cloak class="quick-search-dropdown"
                    style="position:absolute;bottom:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-primary);border-radius:4px;margin-bottom:4px;z-index:9999;">
                    <template x-for="(item, idx) in workshopQuickSearchMatches" :key="item.id">
                        <div class="quick-search-item"
                            @click="window.workshopChat.selectWorkshopQuickMatch($data, item)"
                            :class="{ 'active': idx === workshopQuickSearchSelectedIndex }"
                            style="padding:8px;cursor:pointer;font-size:13px;">
                            <div style="font-weight:600;" x-text="item.title"></div>
                            <div style="font-size:11px;color:var(--text-secondary);" x-text="item.category">
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Scene Search Dropdown -->
                <div x-show="showWorkshopSceneSearch" x-cloak class="scene-search-dropdown"
                    style="position:absolute;bottom:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-primary);border:1px solid var(--border-primary);border-radius:4px;margin-bottom:4px;z-index:9999;">
                    <template x-for="(scene, idx) in workshopSceneSearchMatches" :key="scene.id">
                        <div class="scene-search-item"
                            @click="window.workshopChat.selectWorkshopSceneMatch($data, scene)"
                            :class="{ 'active': idx === workshopSceneSearchSelectedIndex }"
                            style="padding:8px;cursor:pointer;font-size:13px;">
                            <div style="font-weight:600;" x-text="scene.title"></div>
                            <div style="font-size:11px;color:var(--text-secondary);">
                                <template x-if="scene.summary">
                                    <span x-text="scene.summary.substring(0, 60) + '...'"></span>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>

                <button class="btn btn-primary" @click="window.workshopChat.sendMessage($data, workshopInput)"
                    :disabled="!workshopInput.trim() || workshopIsGenerating"
                    style="align-self:flex-end;margin-top:8px;">
                    <span x-show="!workshopIsGenerating">Send</span>
                    <span x-show="workshopIsGenerating">Sending...</span>
                </button>
            </div>
            <div style="font-size:12px;color:var(--text-secondary);margin-top:6px;">
                Press Enter to send, Shift+Enter for new line. Type @ for compendium, # for scenes.
            </div>
        </div>
    </div>

    <!-- Right: Context Panel (Optional - can be toggled) -->
    <div class="workshop-context" x-show="showWorkshopContext" x-cloak>
        <div class="workshop-context-header">
            <h4 style="margin:0;font-size:14px;">Quick Reference</h4>
            <button class="btn-icon-sm" @click="showWorkshopContext = false">√ó</button>
        </div>
        <div class="workshop-context-content">
            <p style="font-size:13px;color:var(--text-secondary);">
                Mentioned items will appear here for quick reference.
            </p>
        </div>
    </div>
</div>